/*
 * SlopOS Font Rendering - Simple Text Rendering System
 * Provides basic text rendering with embedded bitmap font
 */

#include <stdint.h>
#include <stddef.h>
#include "../lib/memory.h"
#include "../boot/constants.h"
#include "../drivers/serial.h"
#include "framebuffer.h"

/* Forward declarations */
int graphics_draw_pixel(int x, int y, uint32_t color);
int graphics_draw_rect_filled(int x, int y, int width, int height, uint32_t color);
uint32_t framebuffer_get_width(void);
uint32_t framebuffer_get_height(void);
int framebuffer_is_initialized(void);

/* ========================================================================
 * FONT CONSTANTS AND STRUCTURES
 * ======================================================================== */

/* Font dimensions */
#define FONT_CHAR_WIDTH     8     /* Character width in pixels */
#define FONT_CHAR_HEIGHT    16    /* Character height in pixels */
#define FONT_FIRST_CHAR     32    /* First printable character (space) */
#define FONT_LAST_CHAR      126   /* Last printable character (~) */
#define FONT_CHAR_COUNT     (FONT_LAST_CHAR - FONT_FIRST_CHAR + 1)

/* Text rendering modes */
#define TEXT_MODE_NORMAL    0     /* Normal text */
#define TEXT_MODE_BOLD      1     /* Bold text (not implemented) */
#define TEXT_MODE_ITALIC    2     /* Italic text (not implemented) */
#define TEXT_MODE_INVERSE   3     /* Inverse colors */

/* Text alignment */
#define TEXT_ALIGN_LEFT     0
#define TEXT_ALIGN_CENTER   1
#define TEXT_ALIGN_RIGHT    2

/* Font error codes */
#define FONT_SUCCESS        0
#define FONT_ERROR_NO_FB    -1
#define FONT_ERROR_BOUNDS   -2
#define FONT_ERROR_INVALID  -3

/* ========================================================================
 * EMBEDDED 8x16 BITMAP FONT DATA
 * ======================================================================== */

/*
 * Simple 8x16 bitmap font for ASCII characters 32-126
 * Each character is represented as 16 bytes (16 rows of 8 pixels each)
 * Bit 7 = leftmost pixel, Bit 0 = rightmost pixel
 */
static const uint8_t font_data[FONT_CHAR_COUNT][FONT_CHAR_HEIGHT] = {
    /* Space (32) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* ! (33) */
    {0x00, 0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x18,
     0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},

    /* " (34) */
    {0x00, 0x00, 0x66, 0x66, 0x66, 0x24, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* # (35) */
    {0x00, 0x00, 0x00, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C,
     0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00},

    /* $ (36) */
    {0x00, 0x00, 0x18, 0x18, 0x7C, 0xC6, 0xC2, 0xC0,
     0x7C, 0x06, 0x06, 0x86, 0xC6, 0x7C, 0x18, 0x18},

    /* % (37) */
    {0x00, 0x00, 0x00, 0x00, 0xC2, 0xC6, 0x0C, 0x18,
     0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00, 0x00},

    /* & (38) */
    {0x00, 0x00, 0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},

    /* ' (39) */
    {0x00, 0x00, 0x30, 0x30, 0x30, 0x60, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* ( (40) */
    {0x00, 0x00, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30,
     0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00},

    /* ) (41) */
    {0x00, 0x00, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C,
     0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},

    /* * (42) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x3C, 0xFF,
     0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* + (43) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x7E,
     0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* , (44) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},

    /* - (45) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* . (46) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},

    /* / (47) */
    {0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x0C, 0x18,
     0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00},

    /* 0 (48) */
    {0x00, 0x00, 0x3C, 0x66, 0xC3, 0xC3, 0xDB, 0xDB,
     0xC3, 0xC3, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* 1 (49) */
    {0x00, 0x00, 0x18, 0x38, 0x58, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00, 0x00},

    /* 2 (50) */
    {0x00, 0x00, 0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30,
     0x60, 0xC0, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},

    /* 3 (51) */
    {0x00, 0x00, 0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06,
     0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* 4 (52) */
    {0x00, 0x00, 0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE,
     0x0C, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00, 0x00},

    /* 5 (53) */
    {0x00, 0x00, 0xFE, 0xC0, 0xC0, 0xC0, 0xFC, 0x06,
     0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* 6 (54) */
    {0x00, 0x00, 0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* 7 (55) */
    {0x00, 0x00, 0xFE, 0xC6, 0x06, 0x06, 0x0C, 0x18,
     0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00},

    /* 8 (56) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* 9 (57) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06,
     0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00, 0x00},

    /* : (58) */
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* ; (59) */
    {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00,
     0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00},

    /* < (60) */
    {0x00, 0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60,
     0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00, 0x00},

    /* = (61) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00,
     0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* > (62) */
    {0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0C, 0x06,
     0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00, 0x00},

    /* ? (63) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18,
     0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},

    /* @ (64) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xDE, 0xDE, 0xDE,
     0xDC, 0xC0, 0xC0, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* A (65) */
    {0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0xC6, 0xFE,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* B (66) */
    {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66,
     0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00, 0x00},

    /* C (67) */
    {0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xC0,
     0xC0, 0xC2, 0x66, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* D (68) */
    {0x00, 0x00, 0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66,
     0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00, 0x00},

    /* E (69) */
    {0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
     0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00},

    /* F (70) */
    {0x00, 0x00, 0xFE, 0x66, 0x62, 0x68, 0x78, 0x68,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},

    /* G (71) */
    {0x00, 0x00, 0x3C, 0x66, 0xC2, 0xC0, 0xC0, 0xDE,
     0xC6, 0xC6, 0x66, 0x3A, 0x00, 0x00, 0x00, 0x00},

    /* H (72) */
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xFE, 0xC6,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* I (73) */
    {0x00, 0x00, 0x3C, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* J (74) */
    {0x00, 0x00, 0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
     0xCC, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00, 0x00},

    /* K (75) */
    {0x00, 0x00, 0xE6, 0x66, 0x6C, 0x78, 0x78, 0x6C,
     0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},

    /* L (76) */
    {0x00, 0x00, 0xF0, 0x60, 0x60, 0x60, 0x60, 0x60,
     0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00, 0x00},

    /* M (77) */
    {0x00, 0x00, 0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* N (78) */
    {0x00, 0x00, 0xC6, 0xE6, 0xF6, 0xFE, 0xDE, 0xCE,
     0xC6, 0xC6, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* O (79) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* P (80) */
    {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},

    /* Q (81) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0xD6, 0xDE, 0x7C, 0x0C, 0x0E, 0x00, 0x00},

    /* R (82) */
    {0x00, 0x00, 0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C,
     0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},

    /* S (83) */
    {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0x60, 0x38, 0x0C,
     0x06, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* T (84) */
    {0x00, 0x00, 0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* U (85) */
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* V (86) */
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6,
     0xC6, 0x6C, 0x38, 0x10, 0x00, 0x00, 0x00, 0x00},

    /* W (87) */
    {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0xD6, 0xD6,
     0xD6, 0xFE, 0xEE, 0x6C, 0x00, 0x00, 0x00, 0x00},

    /* X (88) */
    {0x00, 0x00, 0xC6, 0xC6, 0x6C, 0x7C, 0x38, 0x38,
     0x7C, 0x6C, 0xC6, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* Y (89) */
    {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* Z (90) */
    {0x00, 0x00, 0xFE, 0xC6, 0x86, 0x0C, 0x18, 0x30,
     0x60, 0xC2, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},

    /* [ (91) */
    {0x00, 0x00, 0x3C, 0x30, 0x30, 0x30, 0x30, 0x30,
     0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* \ (92) */
    {0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18,
     0x0C, 0x06, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* ] (93) */
    {0x00, 0x00, 0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C,
     0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* ^ (94) */
    {0x00, 0x00, 0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* _ (95) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00},

    /* ` (96) - simplified */
    {0x00, 0x00, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    /* a (97) - simplified lowercase */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},

    /* b (98) */
    {0x00, 0x00, 0xE0, 0x60, 0x60, 0x78, 0x6C, 0x66,
     0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* c (99) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0,
     0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* d (100) */
    {0x00, 0x00, 0x1C, 0x0C, 0x0C, 0x3C, 0x6C, 0xCC,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},

    /* e (101) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE,
     0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* f (102) */
    {0x00, 0x00, 0x1C, 0x36, 0x32, 0x30, 0x78, 0x30,
     0x30, 0x30, 0x30, 0x78, 0x00, 0x00, 0x00, 0x00},

    /* g (103) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
     0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00, 0x00},

    /* h (104) */
    {0x00, 0x00, 0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66,
     0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},

    /* i (105) */
    {0x00, 0x00, 0x18, 0x18, 0x00, 0x38, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* j (106) */
    {0x00, 0x00, 0x06, 0x06, 0x00, 0x0E, 0x06, 0x06,
     0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00, 0x00},

    /* k (107) */
    {0x00, 0x00, 0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78,
     0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00, 0x00},

    /* l (108) */
    {0x00, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18,
     0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00, 0x00},

    /* m (109) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xEC, 0xFE, 0xD6,
     0xD6, 0xD6, 0xD6, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* n (110) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
     0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00},

    /* o (111) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6,
     0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* p (112) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x66, 0x66,
     0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00, 0x00},

    /* q (113) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC,
     0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00, 0x00},

    /* r (114) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xDC, 0x76, 0x66,
     0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00, 0x00},

    /* s (115) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0xC6, 0x60,
     0x38, 0x0C, 0xC6, 0x7C, 0x00, 0x00, 0x00, 0x00},

    /* t (116) */
    {0x00, 0x00, 0x10, 0x30, 0x30, 0xFC, 0x30, 0x30,
     0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00, 0x00},

    /* u (117) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC,
     0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},

    /* v (118) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66,
     0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00, 0x00},

    /* w (119) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6,
     0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00, 0x00},

    /* x (120) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38,
     0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},

    /* y (121) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6,
     0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00, 0x00},

    /* z (122) */
    {0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18,
     0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00, 0x00},

    /* { (123) */
    {0x00, 0x00, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x18,
     0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00, 0x00},

    /* | (124) */
    {0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18,
     0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},

    /* } (125) */
    {0x00, 0x00, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x18,
     0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00},

    /* ~ (126) - last character */
    {0x00, 0x00, 0x76, 0xDC, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

/* ========================================================================
 * TEXT RENDERING FUNCTIONS
 * ======================================================================== */

/*
 * Draw a single character at specified position
 */
int font_draw_char(int x, int y, char c, uint32_t fg_color, uint32_t bg_color) {
    if (!framebuffer_is_initialized()) {
        return FONT_ERROR_NO_FB;
    }

    /* Check if character is printable */
    if (c < FONT_FIRST_CHAR || c > FONT_LAST_CHAR) {
        c = ' '; /* Replace with space for unprintable characters */
    }

    /* Get font data for character */
    int char_index = c - FONT_FIRST_CHAR;
    const uint8_t *char_data = font_data[char_index];

    /* Draw character bitmap */
    for (int row = 0; row < FONT_CHAR_HEIGHT; row++) {
        uint8_t byte = char_data[row];
        for (int col = 0; col < FONT_CHAR_WIDTH; col++) {
            int px = x + col;
            int py = y + row;

            /* Check bounds */
            if (px < 0 || py < 0 || px >= (int)framebuffer_get_width() ||
                py >= (int)framebuffer_get_height()) {
                continue;
            }

            /* Draw pixel based on bit state */
            if (byte & (0x80 >> col)) {
                graphics_draw_pixel(px, py, fg_color);
            } else if (bg_color != 0) { /* Only draw background if not transparent */
                graphics_draw_pixel(px, py, bg_color);
            }
        }
    }

    return FONT_SUCCESS;
}

/*
 * Draw a string at specified position
 */
int font_draw_string(int x, int y, const char *str, uint32_t fg_color, uint32_t bg_color) {
    if (!framebuffer_is_initialized()) {
        return FONT_ERROR_NO_FB;
    }

    if (!str) {
        return FONT_ERROR_INVALID;
    }

    int current_x = x;
    int current_y = y;

    while (*str) {
        char c = *str;

        /* Handle special characters */
        if (c == '\n') {
            current_x = x; /* Reset to start of line */
            current_y += FONT_CHAR_HEIGHT;
        } else if (c == '\r') {
            current_x = x; /* Reset to start of line */
        } else if (c == '\t') {
            /* Tab - align to next 4-character boundary */
            int tab_width = 4 * FONT_CHAR_WIDTH;
            current_x = ((current_x - x + tab_width) / tab_width) * tab_width + x;
        } else {
            /* Draw regular character */
            font_draw_char(current_x, current_y, c, fg_color, bg_color);
            current_x += FONT_CHAR_WIDTH;

            /* Wrap to next line if necessary */
            if (current_x + FONT_CHAR_WIDTH > (int)framebuffer_get_width()) {
                current_x = x;
                current_y += FONT_CHAR_HEIGHT;
            }
        }

        /* Check if we've gone off the bottom of the screen */
        if (current_y >= (int)framebuffer_get_height()) {
            break;
        }

        str++;
    }

    return FONT_SUCCESS;
}

/*
 * Draw a string with background clearing
 */
int font_draw_string_clear(int x, int y, const char *str, uint32_t fg_color, uint32_t bg_color) {
    if (!str) {
        return FONT_ERROR_INVALID;
    }

    /* Calculate string dimensions */
    int len = 0;
    const char *p = str;
    while (*p && *p != '\n') {
        len++;
        p++;
    }

    /* Clear background area */
    int width = len * FONT_CHAR_WIDTH;
    int height = FONT_CHAR_HEIGHT;
    graphics_draw_rect_filled(x, y, width, height, bg_color);

    /* Draw string */
    return font_draw_string(x, y, str, fg_color, bg_color);
}

/*
 * Get string width in pixels
 */
int font_get_string_width(const char *str) {
    if (!str) {
        return 0;
    }

    int width = 0;
    while (*str && *str != '\n') {
        if (*str == '\t') {
            /* Tab - align to next 4-character boundary */
            width = ((width + 4 * FONT_CHAR_WIDTH - 1) / (4 * FONT_CHAR_WIDTH)) * (4 * FONT_CHAR_WIDTH);
        } else {
            width += FONT_CHAR_WIDTH;
        }
        str++;
    }
    return width;
}

/*
 * Get number of lines in string
 */
int font_get_string_lines(const char *str) {
    if (!str) {
        return 0;
    }

    int lines = 1;
    while (*str) {
        if (*str == '\n') {
            lines++;
        }
        str++;
    }
    return lines;
}

/* ========================================================================
 * CONSOLE-STYLE TEXT OUTPUT
 * ======================================================================== */

/* Simple console state */
static struct {
    int cursor_x;
    int cursor_y;
    uint32_t fg_color;
    uint32_t bg_color;
    int initialized;
} console = {0, 0, 0xFFFFFFFF, 0x00000000, 0};

/*
 * Scroll framebuffer up by one character row
 */
static void font_console_scroll_up(void) {
    framebuffer_info_t *info = framebuffer_get_info();
    if (!info || !info->initialized) {
        return;
    }

    uint8_t *buffer = info->virtual_addr;
    uint32_t pitch = info->pitch;
    uint32_t bytes_per_pixel = info->bpp / 8;

    if (!buffer || pitch == 0 || bytes_per_pixel == 0) {
        return;
    }

    if (info->height <= FONT_CHAR_HEIGHT) {
        graphics_draw_rect_filled(0, 0, info->width, info->height, console.bg_color);
        console.cursor_y = 0;
        return;
    }

    size_t src_offset = (size_t)FONT_CHAR_HEIGHT * pitch;
    size_t copy_bytes = (size_t)(info->height - FONT_CHAR_HEIGHT) * pitch;

    memmove(buffer, buffer + src_offset, copy_bytes);
    graphics_draw_rect_filled(0, info->height - FONT_CHAR_HEIGHT,
                              info->width, FONT_CHAR_HEIGHT, console.bg_color);
    console.cursor_y = (int)info->height - FONT_CHAR_HEIGHT;
}

/*
 * Initialize console
 */
void font_console_init(uint32_t fg_color, uint32_t bg_color) {
    console.cursor_x = 0;
    console.cursor_y = 0;
    console.fg_color = fg_color;
    console.bg_color = bg_color;
    console.initialized = 1;
}

/*
 * Print character to console
 */
int font_console_putc(char c) {
    if (!framebuffer_is_initialized() || !console.initialized) {
        return FONT_ERROR_NO_FB;
    }

    if (c == '\n') {
        console.cursor_x = 0;
        console.cursor_y += FONT_CHAR_HEIGHT;
    } else if (c == '\r') {
        console.cursor_x = 0;
    } else {
        font_draw_char(console.cursor_x, console.cursor_y, c,
                      console.fg_color, console.bg_color);
        console.cursor_x += FONT_CHAR_WIDTH;

        /* Line wrap */
        if (console.cursor_x + FONT_CHAR_WIDTH > (int)framebuffer_get_width()) {
            console.cursor_x = 0;
            console.cursor_y += FONT_CHAR_HEIGHT;
        }
    }

    /* Scroll if necessary */
    if (console.cursor_y + FONT_CHAR_HEIGHT > (int)framebuffer_get_height()) {
        font_console_scroll_up();
    }

    return FONT_SUCCESS;
}

/*
 * Print string to console
 */
int font_console_puts(const char *str) {
    if (!str) {
        return FONT_ERROR_INVALID;
    }

    while (*str) {
        font_console_putc(*str);
        str++;
    }

    return FONT_SUCCESS;
}

/*
 * Clear console
 */
int font_console_clear(void) {
    if (!framebuffer_is_initialized()) {
        return FONT_ERROR_NO_FB;
    }

    /* Clear entire framebuffer with background color */
    graphics_draw_rect_filled(0, 0, framebuffer_get_width(),
                             framebuffer_get_height(), console.bg_color);

    /* Reset cursor */
    console.cursor_x = 0;
    console.cursor_y = 0;

    return FONT_SUCCESS;
}

/*
 * Set console colors
 */
void font_console_set_colors(uint32_t fg_color, uint32_t bg_color) {
    console.fg_color = fg_color;
    console.bg_color = bg_color;
}
